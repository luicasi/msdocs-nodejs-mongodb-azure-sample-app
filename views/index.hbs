<script type="text/javascript">
var app = (() => {
  function showPage(page) {
    $("div[page]").each((index, element) => {
      if ($(element).attr("page") != page){
        $(element).hide();
      }
    })
    $("div[page='" + page +"']").show();
  }

  function formatDate(d) 
  {
    var ret = "";
    var d2 = new Date(parseInt(d.substr(0, 4), 10), parseInt(d.substr(4, 2), 10) - 1, parseInt(d.substr(6, 2), 10), 0, 0, 0);
    
    return Date.Format(d2, "dddd dd/mm");		
  }

  return {
    showPage: showPage,
    formatDate: formatDate
  }

})();

var main = (() => {
  var selectedDate = null;
  var displayAll = false;

  function init() {

  }

  function show(bLoadData) {
    if (bLoadData) {
      loadData(); 
    }
    else {
      app.showPage("main");
    }
  }

  function loadData() 
  {	
    ajaxCall2("/data/dates_list", {opt: displayAll ? 1 : 0}, loadDataCB);
  }

  function loadDataCB(sentData, retData) 
  {	
    var cnt = $("div[name=data-cnt]");
    clearContent(cnt);
    
    $.each(retData.data, function(index, item) {
      var i = createFromTemplate(cnt);
      i.data("data", item);
      $("span[name=data]", i).text(app.formatDate(item.date));
      if (item.status == 0){
        $("span[name=testo]", i).text("Nessuna immagine");
      }
      else if (item.status == 1){
        $("span[name=testo]", i).text(`${item.openPictures} immagini da lavorare su ${item.totalPictures}`);
      }
      else if (item.status == 2){
        $("span[name=testo]", i).text(`Completato, ${item.totalPictures} immagini`);
      }
      else if (item.status == 3){
        $("span[name=testo]", i).text("Giorno non lavorativo");
      }
      else if (item.status == 4){
        $("span[name=testo]", i).text("Nessuna immagine");
      }

      $("label[name=bt1]", i).attr("for", "file" + index);
      $("input[name=file]", i).attr("id", "file" + index);

      setVisible($("label[name=bt1]", i).closest("div"), item.status == 0 || item.status == 1);
      setVisible($("label[name=bt2]", i).closest("div"), item.status == 1);
      setVisible($("label[name=bt3]", i).closest("div"), item.status == 0);
      setVisible($("label[name=bt4]", i).closest("div"), item.status == 0);

      $("input[name=file]", i).on("change", fileChange)
      $("label", i).on("click", onButtonClick);
      $(i).on("click", onDateClick);
    });	
    
    app.showPage("main")
  }


  function onButtonClick() {
    const div = $(this).closest("div.data");
    const item = div.data("data");

    selectedDate = item.date;

    $(this).toggleClass("open");

    const name = $(this).attr("name");

    if (name == "bt1"){
      //showShoot(item.date);
    }
    else if (name == "bt2"){
      showPictures(item.date);
    }
    else if (name == "bt3"){
      if (confirm("Questa data non sarà più modificabile dopo l'operazione\nConfermi?"))
      {
        fetch("/data/add_not_working_day", {
          method:'POST',
          body:new URLSearchParams({ 'date': selectedDate })
          })
        .then(res => {
            if (res.ok) 
                div.remove();
            else 
                alert(res.text());
            })
        .catch(err => alert(err.message))
      }
    }
    else if (name == "bt4"){
      if (confirm("Questa data non sarà più modificabile dopo l'operazione\nConfermi?"))
      {
        fetch("/data/add_empty_day", {
          method:'POST',
          body:new URLSearchParams({ 'date': selectedDate })
          })
        .then(res => {
            if (res.ok) 
                div.remove();
            else 
                alert(res.text());
            })
        .catch(err => alert(err.message))
      }
    }
    else {
      alert(app.formatDate(item.date) + "\n" + $(this).text());
    }
  }

  function onDateClick() {
    if ($(this).is(".open"))
    {
      $(this).removeClass("open");
    }
    else {
      $("div.data.open", "div[page=main]").removeClass("open");
      $(this).toggleClass("open");
    }
  }

  function fileChange(ev) 
  {
    $.LoadingOverlay("show");

    const form = new FormData();
    form.append("date", selectedDate);
    form.append("file", ev.target.files[0])
    fetch("data/add_picture", {
      method:'POST',
      body:form,
    }, )
    .then(res => {
       $.LoadingOverlay("hide");
        ev.target.value = "";
        if (res.ok) 
            pictures.show(selectedDate);
        else 
            alert(res.text());
        })
    .catch(err => {
      $.LoadingOverlay("hide");
      alert(err);
    })
  }

  return {
    init: init,
    show: show
  }
})();

var pictures = (() => {

  var currentDate;
  var cnt;

  function init() {
    cnt = $("div[page=pictures]");

    $("a[name=home]", cnt).on("click", () => main.show(true))
    $("a[name=shoot]", cnt).on("click", () => shoot.show(currentDate))
    $("#file1").on("change", fileChange);
  }

  function show(dt) {
    currentDate = dt;
    $("span[name=date]", cnt).text(app.formatDate(currentDate));
    loadData();
  }

  function loadData() 
  {	
    ajaxCall2("/data/pictures_list", {date: currentDate}, loadDataCB);
  }

  function loadDataCB(sentData, retData) 
  {	
    var cntPics = $("div[name=pictures-cnt]", cnt);
    clearContent(cntPics);
    
    $.each(retData.data, function(index, item) {
      var i = createFromTemplate(cntPics);
      i.data("data", item);
      $("img", i).attr("src", `https://${item.accountName}.blob.core.windows.net/${item.containerName}/${item.name}`);

      $("button[name=done]", i).on("click", onDoneClick);
    });	
    
    app.showPage("pictures")
  }

  function fileChange(ev) 
  {
    $.LoadingOverlay("show");

    const form = new FormData();
    form.append("date", currentDate);
    form.append("file", ev.target.files[0])
    fetch("data/add_picture", {
      method:'POST',
      body:form,
    }, )
    .then(res => {
       $.LoadingOverlay("hide");
        ev.target.value = "";
        if (res.ok) 
            loadData();
        else 
            alert(res.text());
        })
    .catch(err => {
      $.LoadingOverlay("hide");
      alert(err);
    })
  }

  function onDoneClick() {
    var item = $(this.closest(".item"));
    var data = item.data("data");

    fetch("/data/set_picture_done", {
      method:'POST',
      body:new URLSearchParams({
        'date': currentDate,
        'name': data.name
    })})
    .then(res => {
        if (res.ok) 
            item.remove();
        else 
            alert(res.text());
        })
    .catch(err => alert(err.message))
  }

  return {
    init: init,
    show: show
  }
})();
function showPictures(dt){
  pictures.show(dt);
}

$(function() {
  main.init();
  pictures.init();

  app.showPage("loading")

  main.show(true);
});

</script>

<div page="loading" style="text-align: center; padding: 20px; ">
  <h3>Avvio applicazione...</h3>
</div>

<div page="main">
  <div name="data-cnt" class="eventi" style="display: flex; flex-wrap: wrap; justify-content: space-evenly; ">
    <div class="template data" style="flex-grow: 1.5; ">
      <span name="data" style="font-weight: bold; "></span>
      <br/>
    <span name="testo" style="font-style: italic; font-size: 10pt; "></span> 
      <br/>
      <div>
      <input type="file" name="file" id="file2" class="hiddeninputfile" accept="image/*"/>
      <label for="file2" class="button" name="bt1">Aggiungi una foto</label>
      </div>
      <div><label class="button" name="bt2">Visualizza le immagini</label><br/></div>
      <div><label class="button" name="bt3">Giorno non lavorativo</label><br/></div>
      <div><label class="button" name="bt4">Nessuna immagine per questo giorno</label><br/></div>
    </div>
  </div>
</div>

<div page="pictures" style="margin: 10px; ">
  <span name="date" style="font-weight: bold; font-size: 12pt; "></span>
  <span>&nbsp;&nbsp; <a name="home" href="javascript: void(0);">[Home]</a></span>
  <span>&nbsp;&nbsp;<input type="file" name="file" id="file1" class="hiddeninputfile" accept="image/*"/>
  <label for="file1" class="link">[Aggiungi una foto]</label></span>
  <hr/>
  <div name="pictures-cnt" style="text-align: center; ">
    <div class="template item">
      <img style="width:250px;">
      <br/>
      <button name="done" style="font-weight: bold; font-size: 12pt; width:250px; padding: 5px; border-radius: 7px; background-color: #FFFFFF; ">Gestita</button>
      <br/><br/>
    </div>
  </div>
</div>

 <div id="uploading" style="display: none;">
      <div class="output">
          <img id="photo" alt="The image captured will appear in this box.">
      </div>
      <br/>
      <button id="uploadpicture">Salva l'immagine</button>
      <button id="shootagain">Scatta un'altra foto</button>
  </div>
</div>